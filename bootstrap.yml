sources:
  # For some weird reason autoconf 2.69 from the autotools-mirror/autoconf
  # GitHub repo fails to build with some weird errors, I'll leave them there
  # for future self: https://gist.github.com/czapek1337/b40ff29a7459f73fdeed63c8a8f8311f
  - name: "autoconf-v2.69"
    subdir: "ports"
    url: "https://ftp.gnu.org/gnu/autoconf/autoconf-2.69.tar.xz"
    format: "tar.xz"
    extract_path: "autoconf-2.69"
    version: "2.69"

  - name: "autoconf-v2.71"
    subdir: "ports"
    git: "https://github.com/autotools-mirror/autoconf.git"
    tag: "v2.71"
    version: "2.71"
    regenerate:
      - args: ["autoreconf", "-fvi"]

  - name: "automake-v1.16"
    subdir: "ports"
    git: "https://github.com/autotools-mirror/automake.git"
    tag: "v1.16.5"
    version: "1.16.5"
    tools_required: ["host-autoconf-v2.71"]
    regenerate:
      - args: ["./bootstrap"]

  - name: "binutils"
    subdir: "ports"
    git: "https://sourceware.org/git/binutils-gdb.git"
    tag: "binutils-2_38"
    version: "2.38"

  - name: "gcc"
    subdir: "ports"
    git: "https://github.com/gcc-mirror/gcc.git"
    tag: "releases/gcc-12.1.0"
    version: "12.1.0"
    tools_required: ["host-autoconf-v2.69", "host-automake-v1.16"]
    regenerate:
      - args: ["./contrib/download_prerequisites"]
        workdir: "@THIS_SOURCE_DIR@"
      - args: ["autoconf"]
        workdir: "@THIS_SOURCE_DIR@/gcc"
      - args: ["autoconf"]
        workdir: "@THIS_SOURCE_DIR@/libstdc++-v3"
      - args: ["cp", "-fv", "@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub", "@THIS_SOURCE_DIR@/"]
      - args: ["cp", "-fv", "@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub", "@THIS_SOURCE_DIR@/gmp-6.2.1/configfsf.sub"]
      - args: ["cp", "-fv", "@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub", "@THIS_SOURCE_DIR@/isl-0.24/config.sub"]
      - args: ["cp", "-fv", "@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub", "@THIS_SOURCE_DIR@/mpc-1.2.1/config.sub"]
      - args: ["cp", "-fv", "@BUILD_ROOT@/tools/host-automake-v1.16/share/automake-1.16/config.sub", "@THIS_SOURCE_DIR@/mpfr-4.1.0/config.sub"]

  - name: "mlibc"
    subdir: "ports"
    git: "https://github.com/managarm/mlibc.git"
    branch: "master"

declare_options:
  - name: "arch"
    default: "x86_64"
  - name: "arch-triple"
    default: "x86_64-zigux"

tools:
  - name: "host-autoconf-v2.69"
    from_source: "autoconf-v2.69"
    configure:
      - args: ["@THIS_SOURCE_DIR@/configure", "--prefix=@PREFIX@"]
    compile:
      - args: ["make", "-j@PARALLELISM@"]
    install:
      - args: ["make", "install"]

  - name: "host-autoconf-v2.71"
    from_source: "autoconf-v2.71"
    configure:
      - args: ["@THIS_SOURCE_DIR@/configure", "--prefix=@PREFIX@"]
    compile:
      - args: ["make", "-j@PARALLELISM@"]
    install:
      - args: ["make", "install"]

  - name: "host-automake-v1.16"
    from_source: "automake-v1.16"
    tools_required: ["host-autoconf-v2.71"]
    configure:
      - args: ["@THIS_SOURCE_DIR@/configure", "--prefix=@PREFIX@"]
    compile:
      - args: |
          set -e
          export PATH="`pwd`/bin:$PATH"
          make bin/aclocal-1.16 bin/automake-1.16 -j@PARALLELISM@
          make -j@PARALLELISM@
    install:
      - args: ["make", "install-strip"]
      - args: ["ln", "-svf", "@PREFIX@/share/aclocal-1.16", "@PREFIX@/share/aclocal"]

  - name: "host-binutils"
    from_source: "binutils"
    tools_required: ["host-autoconf-v2.71", "host-automake-v1.16"]
    configure:
      - args:
          - "@THIS_SOURCE_DIR@/configure"
          - "--prefix=@PREFIX@"
          - "--target=@OPTION:arch-triple@"
          - "--with-sysroot=@SYSROOT_DIR@"
          - "--enable-targets=x86_64-elf,x86_64-pe"
    compile:
      - args: ["make", "-j@PARALLELISM@", "all-binutils", "all-gas", "all-ld"]
    install:
      - args: ["make", "install-strip-binutils", "install-strip-gas", "install-strip-ld"]

  - name: "host-gcc"
    from_source: "gcc"
    tools_required:
      - tool: "host-binutils"
        recursive: true
    configure:
      - args:
          - "@THIS_SOURCE_DIR@/configure"
          - "--prefix=@PREFIX@"
          - "--target=@OPTION:arch-triple@"
          - "--with-sysroot=@SYSROOT_DIR@"
          - "--enable-languages=c,c++"
          - "--disable-multilib"
          - "--enable-initfini-array"
    stages:
      - name: "compiler"
        pkgs_required: ["mlibc-headers"]
        compile:
          - args: ["make", "-j@PARALLELISM@", "all-gcc"]
        install:
          - args: ["make", "install-gcc"]
          - args: ["mkdir", "-pv", "@PREFIX@/@OPTION:arch-triple@/bin"]
          - args: ["ln", "-svf", "../../../host-binutils/@OPTION:arch-triple@/bin/as", "@PREFIX@/@OPTION:arch-triple@/bin/as"]
          - args: ["ln", "-svf", "../../../host-binutils/@OPTION:arch-triple@/bin/ld", "@PREFIX@/@OPTION:arch-triple@/bin/ld"]
      - name: "libgcc"
        tools_required:
          - tool: "host-gcc"
            stage_dependencies: ["compiler"]
        pkgs_required: ["mlibc"]
        compile:
          - args: ["make", "-j@PARALLELISM@", "all-target-libgcc"]
        install:
          - args: ["make", "install-strip-target-libgcc"]
      - name: "libstdc++"
        tools_required:
          - tool: "host-gcc"
            stage_dependencies: ["libgcc"]
        compile:
          - args: ["make", "-j@PARALLELISM@", "all-target-libstdc++-v3"]
        install:
          - args: ["make", "install-strip-target-libstdc++-v3"]

packages:
  - name: "mlibc-headers"
    from_source: "mlibc"
    implict_package: true
    configure:
      - args:
          - "meson"
          - "-Dheaders_only=true"
          - "-Ddisable_iconv_option=true"
          - "-Dbuildtype=debug"
          - "--prefix=/usr"
          - "--cross-file"
          - "@SOURCE_ROOT@/misc/cross.ini"
          - "@THIS_SOURCE_DIR@"
    build:
      - args: ["ninja"]
      - args: ["ninja", "install"]
        environ:
          DESTDIR: "@THIS_COLLECT_DIR@"

  - name: "mlibc"
    from_source: "mlibc"
    tools_required:
      - tool: "host-gcc"
        stage_dependencies: ["compiler"]
    implict_package: true
    pkgs_required: ["mlibc-headers"]
    configure:
      - args:
          - "meson"
          - "-Dmlibc_no_headers=true"
          - "-Ddisable_iconv_option=true"
          - "-Dbuildtype=debug"
          - "--prefix=/usr"
          - "--libdir=lib"
          - "--cross-file"
          - "@SOURCE_ROOT@/misc/cross.ini"
          - "@THIS_SOURCE_DIR@"
    build:
      - args: ["ninja"]
      - args: ["ninja", "install"]
        environ:
          DESTDIR: "@THIS_COLLECT_DIR@"

  - name: "hello-mlibc"
    source:
      subdir: "user"
    tools_required: ["host-gcc"]
    configure:
      - args:
          - "meson"
          - "-Dbuildtype=debug"
          - "--prefix=/usr"
          - "--cross-file"
          - "@SOURCE_ROOT@/misc/cross.ini"
          - "@THIS_SOURCE_DIR@"
    build:
      - args: ["ninja"]
      - args: ["ninja", "install"]
        environ:
          DESTDIR: "@THIS_COLLECT_DIR@"
