From d8f07821f4d5c528290798044a9bcc49933ec1d1 Mon Sep 17 00:00:00 2001
From: czapek1337 <czapek1337@gmail.com>
Date: Mon, 23 May 2022 05:42:08 +0200
Subject: [PATCH] Implement the sys_tcb_set sysdep

---
 sysdeps/zigux/include/zigux/syscall.h |  1 +
 sysdeps/zigux/src/sysdeps.cpp         | 16 +++++++++++++++-
 2 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/sysdeps/zigux/include/zigux/syscall.h b/sysdeps/zigux/include/zigux/syscall.h
index 08e1b65..48d3914 100644
--- a/sysdeps/zigux/include/zigux/syscall.h
+++ b/sysdeps/zigux/include/zigux/syscall.h
@@ -5,6 +5,7 @@
 
 #define SYS_PROC_EXIT 0x0
 #define SYS_PROC_LOG 0x1
+#define SYS_PROC_ARCH_CTL 0x2
 
 #define SYS_FILE_OPEN 0x100
 #define SYS_FILE_CLOSE 0x101
diff --git a/sysdeps/zigux/src/sysdeps.cpp b/sysdeps/zigux/src/sysdeps.cpp
index 45e4ea4..f02b591 100644
--- a/sysdeps/zigux/src/sysdeps.cpp
+++ b/sysdeps/zigux/src/sysdeps.cpp
@@ -8,6 +8,11 @@
 #include <mlibc/posix-sysdeps.hpp>
 #include <zigux/syscall.h>
 
+const auto ARCH_SET_GS = 0x1001;
+const auto ARCH_SET_FS = 0x1002;
+const auto ARCH_GET_FS = 0x1003;
+const auto ARCH_GET_GS = 0x1004;
+
 #define STUB_IMPL(name) { sys_libc_log("Stub function " #name " was called"); sys_libc_panic(); }
 
 namespace mlibc {
@@ -21,10 +26,19 @@ void sys_libc_log(const char *message) {
 }
 
 [[noreturn]] void sys_libc_panic() {
+    sys_libc_log("mlibc panic!");
     sys_exit(1);
 }
 
-int sys_tcb_set(void *pointer) STUB_IMPL(sys_tcb_set)
+int sys_tcb_set(void *pointer) {
+    auto res = do_syscall(SYS_PROC_ARCH_CTL, ARCH_SET_FS, pointer);
+
+    if (auto err = syscall_error(res))
+        return err;
+
+    return 0;
+}
+
 int sys_futex_wait(int *pointer, int expected, const struct timespec *time) STUB_IMPL(sys_futex_wait)
 int sys_futex_wake(int *pointer) STUB_IMPL(sys_futex_wake)
 
-- 
2.36.1

