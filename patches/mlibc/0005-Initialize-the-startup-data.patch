From 69eee33b3da2b310c332641b35f574db5acf8d37 Mon Sep 17 00:00:00 2001
From: czapek1337 <czapek1337@gmail.com>
Date: Mon, 23 May 2022 21:00:46 +0200
Subject: [PATCH] Initialize the startup data

---
 sysdeps/zigux/meson.build       |  1 -
 sysdeps/zigux/src/crt0-x86_64.S |  4 +---
 sysdeps/zigux/src/entry.cpp     | 19 ++++++++++++++++++-
 3 files changed, 19 insertions(+), 5 deletions(-)

diff --git a/sysdeps/zigux/meson.build b/sysdeps/zigux/meson.build
index a299eb3..0c265e5 100644
--- a/sysdeps/zigux/meson.build
+++ b/sysdeps/zigux/meson.build
@@ -53,4 +53,3 @@ if not headers_only
 		build_by_default: true,
 	)
 endif
-
diff --git a/sysdeps/zigux/src/crt0-x86_64.S b/sysdeps/zigux/src/crt0-x86_64.S
index 3e47559..93d47f1 100644
--- a/sysdeps/zigux/src/crt0-x86_64.S
+++ b/sysdeps/zigux/src/crt0-x86_64.S
@@ -3,7 +3,5 @@
 .global _start
 
 _start:
-    mov $main, %rdi
+    lea main(%rip), %rdi
     call mlibc_entry
-
-.size _start, . - _start
diff --git a/sysdeps/zigux/src/entry.cpp b/sysdeps/zigux/src/entry.cpp
index b88b11d..23d499c 100644
--- a/sysdeps/zigux/src/entry.cpp
+++ b/sysdeps/zigux/src/entry.cpp
@@ -1,7 +1,24 @@
+#include <stdint.h>
 #include <stdlib.h>
+#include <mlibc/elf/startup.h>
+
+extern char **environ;
+
+extern "C" uintptr_t *__dlapi_entrystack();
+
+void __mlibc_initLocale();
+
+static mlibc::exec_stack_data stack_data;
+
+__attribute__((constructor)) static void mlibc_init() {
+  __mlibc_initLocale();
+
+  mlibc::parse_exec_stack(__dlapi_entrystack(), &stack_data);
+  mlibc::set_startup_data(stack_data.argc, stack_data.argv, stack_data.envp);
+}
 
 extern "C" void mlibc_entry(int (*main_fn)(int, char **, char **)) {
-  auto result = main_fn(0, nullptr, nullptr);
+  int result = main_fn(stack_data.argc, stack_data.argv, environ);
 
   exit(result);
 }
-- 
2.36.1

